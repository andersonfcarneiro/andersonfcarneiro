<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel de Metas 2025 ‚Äì SMA</title>
  <!-- Chart.js for analysis dashboard -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- jsPDF and html2canvas for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --bg: #0b0f19;
      --surface: #0f172a;
      --card: #111827;
      --elev: #0b1220;
      --text: #e5eef5;
      --muted: #9fb3c8;
      --line: #1f2a44;
      --accent: #3b82f6;
      --good: #10b981;
      --warn: #f59e0b;
      --bad: #ef4444;
      --pink: #ec4899;
      --purple: #8b5cf6;
      --cyan: #06b6d4;
      --green: #22c55e;
      --blue: #3b82f6;
    }

    body.light-theme {
      --bg: #f1f5f9;
      --surface: #ffffff;
      --card: #ffffff;
      --elev: #f8fafc;
      --text: #0f172a;
      --muted: #64748b;
      --line: #e2e8f0;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; transition: background-color 0.3s ease; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      -webkit-font-smoothing: antialiased;
      line-height: 1.4;
    }
    header {
      position: sticky; top: 0; z-index: 10;
      backdrop-filter: blur(8px);
      background: color-mix(in srgb, var(--bg) 85%, transparent);
      border-bottom: 1px solid var(--line);
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }
    .bar {
      max-width: 1200px; margin: 0 auto; padding: 16px 20px;
      display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: center;
    }
    .title { display: flex; gap: 12px; align-items: center; }
    .logo {
      width: 36px; height: 36px; border-radius: 10px;
      background: linear-gradient(135deg, var(--blue), var(--purple));
      display: grid; place-items: center; font-weight: 700; color: #fff;
      box-shadow: 0 8px 24px rgba(59,130,246,.35), inset 0 0 20px rgba(255,255,255,.06);
    }
    .title h1 { margin: 0; font-size: 18px; letter-spacing: .2px; }
    .title .sub { color: var(--muted); font-size: 12px; }
    .controls { display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; }
    .chip, .btn {
      background: var(--surface);
      color: var(--text); border: 1px solid var(--line);
      padding: 10px 12px; border-radius: 10px; font-size: 14px;
      display: inline-flex; gap: 8px; align-items: center;
      cursor: pointer; transition: all .2s ease;
    }
    .chip:hover, .btn:hover { border-color: color-mix(in srgb, var(--muted) 50%, transparent); transform: translateY(-1px); }
    .chip input, .chip select {
      background: transparent; border: 0; color: var(--text); outline: none;
      font: inherit; min-width: 160px;
    }
    .btn.accent { background: linear-gradient(135deg, #2563eb, #7c3aed); border-color: transparent; color: #fff;}
    .btn.accent:hover { filter: brightness(1.05); }
    main { max-width: 1200px; margin: 12px auto 56px; padding: 0 20px; }
    .card {
      background: var(--card);
      border: 1px solid var(--line); border-radius: 16px; padding: 16px;
      transition: all .2s; position: relative; overflow: hidden;
    }
    .card:hover { border-color: color-mix(in srgb, var(--muted) 60%, transparent); }
    .card .head { display: flex; gap: 12px; align-items: center; justify-content: space-between; margin-bottom: 10px; flex-wrap: wrap; }
    .card h2 { margin: 0; font-size: 16px; }
    .meta-tags { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .tag { font-size: 12px; color: var(--muted); background: var(--surface); border: 1px solid var(--line); padding: 6px 8px; border-radius: 10px; }
    .sections { display: grid; grid-template-columns: repeat(12,1fr); gap: 12px; }
    .sec { grid-column: span 6; background: var(--surface); border: 1px solid var(--line); border-radius: 12px; padding: 12px; }
    .sec h4 { margin: 0 0 8px; font-size: 13px; color: var(--muted); }
    ul { margin: 0; padding-left: 18px; }
    li { margin: 6px 0; }
    .foot { display: flex; gap: 10px; align-items: center; margin-top: 12px; justify-content: space-between; flex-wrap: wrap; }
    .ghost { background: transparent; border-color: var(--line); }
    dialog {
      width: min(980px, 94vw); border: 1px solid var(--line); border-radius: 16px; padding: 0; background: var(--bg); color: var(--text);
      box-shadow: 0 30px 80px rgba(0,0,0,.5);
    }
    dialog::backdrop { background: rgba(3,6,12,.6); backdrop-filter: blur(2px); }
    .modal-head { padding: 14px 16px; border-bottom: 1px solid var(--line); display: flex; justify-content: space-between; align-items: center; }
    .modal-body { padding: 16px; max-height: 80vh; overflow-y: auto; }
    .modal-content { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; }
    .close { background: transparent; border: 1px solid var(--line); color: var(--text); border-radius: 10px; padding: 8px 10px; cursor: pointer; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
    footer { text-align: center; max-width: 1200px; margin: 24px auto 48px; padding: 0 20px; color: var(--muted); font-size: 12px; }
    .hidden { display: none !important; }

    /* Timeline */
    .timeline { padding: 12px 0 4px; }
    .timeline-bar { position: relative; height: 4px; background: var(--line); border-radius: 2px; }
    .timeline-marker {
      position: absolute; top: 50%; transform: translateY(-50%);
      width: 10px; height: 10px; border-radius: 50%; background: var(--muted);
      border: 2px solid var(--card);
    }
    .timeline-marker:hover::after {
      content: attr(data-label); position: absolute; bottom: 100%; left: 50%;
      transform: translateX(-50%); margin-bottom: 6px; background: var(--elev);
      padding: 4px 8px; border-radius: 6px; font-size: 12px; white-space: nowrap;
      border: 1px solid var(--line);
    }

    /* History Log in Modal */
    .history-log { background: var(--surface); border: 1px solid var(--line); border-radius: 12px; padding: 12px; }
    .history-item { border-bottom: 1px solid var(--line); padding: 8px 0; font-size: 13px; }
    .history-item:last-child { border-bottom: none; }
    .history-item small { color: var(--muted); display: block; margin-bottom: 4px; }
    .history-form textarea {
      width: 100%; background: var(--surface); border: 1px solid var(--line);
      border-radius: 8px; color: var(--text); padding: 8px; margin-top: 12px;
      min-height: 60px; font: inherit;
    }

    /* Summary & Analysis Views */
    .fullscreen-view {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: var(--bg); z-index: 20; overflow-y: auto; padding: 20px;
    }
    .fullscreen-content { max-width: 900px; margin: 40px auto 100px; }
    .fullscreen-controls {
      position: fixed; bottom: 0; left: 0; width: 100%;
      background: linear-gradient(to top, var(--bg), transparent);
      padding: 20px; display: flex; justify-content: center; gap: 12px;
    }
    .progress-input {
      background: var(--surface); border: 1px solid var(--line); border-radius: 8px;
      color: var(--text); padding: 4px 8px; width: 70px; text-align: center;
      margin-left: 12px;
    }
    .chart-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 24px; }
    .chart-container { background: var(--surface); padding: 16px; border-radius: 16px; border: 1px solid var(--line); }

    /* Responsive adjustments */
    @media (max-width: 1024px) { .chart-grid { grid-template-columns: 1fr; } }
    @media (max-width: 768px) {
      .bar { grid-template-columns: 1fr; gap: 16px; }
      .controls { justify-content: flex-start; }
      .modal-content { grid-template-columns: 1fr; }
      .chip input { min-width: 0; width: 100%; }
      .foot { flex-direction: column; align-items: flex-start; gap: 12px; }
    }
    @media (max-width: 480px) {
      .title { flex-direction: column; align-items: flex-start; gap: 8px; }
      .title h1 { font-size: 16px; }
      .chip, .btn { width: 100%; justify-content: center; }
      .chip select { width: 100%; }
    }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="title">
        <div class="logo">SMA</div>
        <div>
          <h1>Painel de Metas 2025 ‚Ä¢ SMA</h1>
          <div class="sub">Secretaria Municipal de Administra√ß√£o</div>
        </div>
      </div>
      <div class="controls">
        <button class="btn ghost" id="theme-toggle">‚òÄÔ∏è</button>
        <button class="btn ghost" id="summaryBtn">üìÑ Resumo</button>
        <button class="btn ghost" id="analysisBtn">üìä An√°lise</button>
        <button class="btn accent" id="printBtn">üñ®Ô∏è Imprimir</button>
      </div>
    </div>
  </header>

  <main id="mainDashboard">
     <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; margin-bottom: 16px;">
        <label class="chip">
          üîé
          <input id="q" placeholder="Filtrar por palavra-chave..." />
        </label>
        <label class="chip">
          üìå
          <select id="statusFilter">
            <option value="all">Todos os status</option>
            <option value="em_andamento">Em andamento</option>
            <option value="risco">Em risco</option>
            <option value="concluido">Conclu√≠do</option>
          </select>
        </label>
     </div>
    <section class="grid" id="grid"></section>
  </main>

  <dialog id="modal">
    <div class="modal-head">
      <div style="display:flex;align-items:center;gap:10px;">
        <div id="modalDot" class="status-dot"></div>
        <strong id="modalTitle">Meta</strong>
      </div>
      <button class="close" onclick="modal.close()">Fechar</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </dialog>

  <!-- Summary View Section -->
  <section id="summarySection" class="fullscreen-view hidden">
    <div class="fullscreen-content" id="summaryContent"></div>
    <div class="fullscreen-controls">
      <button class="btn ghost" id="backToDashboardBtn">Voltar ao Painel</button>
      <button class="btn accent" id="printSummaryBtn">üñ®Ô∏è Gerar PDF do Resumo</button>
    </div>
  </section>

  <!-- Analysis View Section -->
  <section id="analysisSection" class="fullscreen-view hidden">
    <div class="fullscreen-content">
        <h1>An√°lise Estrat√©gica do Portf√≥lio</h1>
        <p>Vis√£o agregada do status, progresso e riscos das metas estrat√©gicas da SMA para 2025.</p>
        <div class="chart-grid">
            <div class="chart-container">
                <h3>Progresso M√©dio por √Årea</h3>
                <canvas id="progressByAreaChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Distribui√ß√£o de Metas por Status</h3>
                <canvas id="statusDistributionChart"></canvas>
            </div>
            <div class="chart-container" style="grid-column: 1 / -1;">
                <h3>Contagem de Riscos por √Årea</h3>
                <canvas id="risksByAreaChart"></canvas>
            </div>
        </div>
    </div>
    <div class="fullscreen-controls">
      <button class="btn ghost" id="backToDashboardBtn2">Voltar ao Painel</button>
    </div>
  </section>

  <footer>
    Painel de Gest√£o Estrat√©gica da Secretaria Municipal de Administra√ß√£o (SMA).
    <br>
    Desenvolvido por Anderson Carneiro, Coordenador Geral de RH.
  </footer>

  <script>
    // --- DATA STORE (Currently in-memory, will be lost on refresh) ---
    let metas = [
      { id: 1, area: "RH", titulo: "Migra√ß√£o das Empresas Municipais para o ERGON", status: "em_andamento", progresso: 25, cor: "var(--blue)", objetivo: "Unificar a gest√£o de RH/folha das empresas municipais no ERGON, com integridade de dados, ader√™ncia normativa e redu√ß√£o de custos operacionais.", entregas: ["Plano diretor de migra√ß√£o por empresa (assessment, mapeamento de dados, cronograma, cutover e revers√£o).","Restabelecimento/valida√ß√£o de ambiente de homologa√ß√£o e testes de regress√£o.","Scripts de ETL, reconcilia√ß√£o de rubricas e saldos, trilhas de auditoria.","Manuais e treinamento para usu√°rios-chave e opera√ß√£o."], indicadores: ["% de empresas migradas dentro do prazo: ‚â•90%","Diverg√™ncia m√°xima entre folhas (antiga vs. ERGON) no m√™s do go-live: ‚â§0,10% do total bruto","Incidentes cr√≠ticos p√≥s-go-live por empresa: 0 no D+5; ‚â§2 no D+30"], prazos: "Ondas trimestrais; cada empresa com gate de homologa√ß√£o e aceite formal.", riscos: "Indisponibilidade de ambientes (mitigar com plano de conting√™ncia), inconsist√™ncias cadastrais (clean-up pr√©vio e testes automatizados).", startDate: "2025-01-01", endDate: "2025-12-31", marcos: [{label: "Onda 1", date: "2025-03-31"}, {label: "Onda 2", date: "2025-06-30"}, {label: "Onda 3", date: "2025-09-30"}], historico: [{date: "2025-08-01", user: "Gestor", comment: "In√≠cio da fase de testes da Onda 1."}] },
      { id: 2, area: "Finan√ßas", titulo: "Revis√£o do Ecossistema de Consignados", status: "em_andamento", progresso: 40, cor: "var(--purple)", objetivo: "Reestruturar conv√™nios de consignado para reduzir o CET ao servidor, ampliar concorr√™ncia e transpar√™ncia, e alinhar a receita institucional a custos de fiscaliza√ß√£o/opera√ß√£o.", entregas: ["Novo regulamento/conv√™nio padr√£o com portabilidade √°gil e transpar√™ncia de CET.","Portal de transpar√™ncia do consignado.","Trilhas de auditoria e SLAs (portabilidade, liquida√ß√£o).","Programa de educa√ß√£o financeira e alerta de superendividamento."], indicadores: ["Redu√ß√£o do CET m√©dio ponderado: ‚àí15% em 12 meses","Tempo m√©dio de portabilidade: ‚â§5 dias √∫teis","% de opera√ß√µes com institui√ß√µes via regras de concorr√™ncia: ‚â•80%","Receita institucional limitada e vinculada: 100% lastreada a custos operacionais."], prazos: "Novo modelo publicado em 120 dias; ades√£o de institui√ß√µes em 180 dias.", riscos: "Repasse de custos ao servidor (mitigar com tetos de CET), litigiosidade (consultoria jur√≠dica pr√©via).", startDate: "2025-02-01", endDate: "2025-07-31", marcos: [{label: "Regulamento", date: "2025-05-31"}, {label: "Ades√£o", date: "2025-07-31"}], historico: [] },
      { id: 3, area: "Tecnologia", titulo: "Gateway Seguro de Pagamento", status: "risco", progresso: 80, cor: "var(--cyan)", objetivo: "Implantar um hub automatizado e audit√°vel de interc√¢mbio de arquivos financeiros, integrado ao ERGON e bancos.", entregas: ["Padr√µes de arquivos, valida√ß√µes, versionamento e logs.","Integra√ß√£o com armazenamento corporativo e rotinas de concilia√ß√£o autom√°tica.","Painel de monitoramento e alarm√≠stica."], indicadores: ["Automa√ß√£o das remessas/retornos: ‚â•95%","Falhas por milh√£o de transa√ß√µes (PPM): ‚â§3","Tempo de ciclo remessa‚Üíconfirma√ß√£o: ‚â§60 min em dias √∫teis"], prazos: "MVP em 90 dias; full em 150 dias.", riscos: "Indisponibilidade de terceiros (fila resiliente), erro humano (valida√ß√µes pr√©-envio).", startDate: "2025-03-01", endDate: "2025-08-31", marcos: [{label: "MVP", date: "2025-05-30"}], historico: [{date: "2025-07-20", user: "Gestor", comment: "Depend√™ncia com fornecedor de API est√° atrasando a entrega. Risco elevado."}] },
      { id: 4, area: "Tecnologia", titulo: "Plataforma de BI de Folha e Pessoas", status: "em_andamento", progresso: 15, cor: "var(--green)", objetivo: "Disponibilizar pain√©is executivos e anal√≠ticos para gest√£o e controle.", entregas: ["Modelo de dados (DW) e dicion√°rio de rubricas/medidas.","Pain√©is: execu√ß√£o de folha, varia√ß√µes, provis√µes, conformidade.","Governan√ßa de dados (pap√©is, acessos, LGPD) e capacita√ß√£o."], indicadores: ["Cobertura de rubricas/√≥rg√£os: 100%","Lat√™ncia de atualiza√ß√£o: D+1","Acur√°cia das medidas-chave: ‚â•99,9%","Ado√ß√£o (NPS interno): ‚â•70"], prazos: "Release inicial em 120 dias; evolu√ß√£o trimestral.", riscos: "Qualidade de origem (regras de valida√ß√£o), uso indevido (RBAC e logs).", startDate: "2025-01-15", endDate: "2025-05-15", marcos: [{label: "Release 1", date: "2025-05-15"}], historico: [] },
      { id: 5, area: "RH", titulo: "Reestrutura√ß√£o dos Cargos", status: "concluido", progresso: 100, cor: "var(--warn)", objetivo: "Redesenhar carreiras e atribui√ß√µes da atividade-meio, com regras claras de aloca√ß√£o e mobilidade, mantendo neutralidade or√ßament√°ria.", entregas: ["Mapa de macrofun√ß√µes e fam√≠lias ocupacionais.","Diagn√≥stico de aloca√ß√£o e gargalos.","Estudo de impacto e minuta de projeto de lei com justificativa t√©cnica."], indicadores: ["Entrega da proposta legislativa ao Executivo: at√© T+150 dias","Neutralidade fiscal demonstrada (Œî despesa): R$ 0","Redu√ß√£o de assimetrias de atribui√ß√µes: ‚â•80% dos cargos com descri√ß√£o atualizada."], prazos: "Consulta interna em 60 dias; minuta em 120; submiss√£o em 150.", riscos: "Depend√™ncia de aprova√ß√£o legislativa (engajamento pr√©vio), resist√™ncia organizacional (participa√ß√£o das √°reas).", startDate: "2025-01-01", endDate: "2025-05-31", marcos: [{label: "Submiss√£o", date: "2025-05-30"}], historico: [{date: "2025-05-28", user: "Gestor", comment: "Proposta de lei finalizada e enviada para o gabinete."}] },
      { id: 6, area: "Finan√ßas", titulo: "Efici√™ncia no Mercado Livre de Energia", status: "em_andamento", progresso: 50, cor: "var(--pink)", objetivo: "Reduzir o custo unit√°rio m√©dio de energia el√©trica das unidades no ACL em ‚â•20% versus o cen√°rio cativo em 2025.", entregas: ["Diagn√≥stico de cargas e estrat√©gia de compras (RFP/leil√£o).","Contratos com comercializadoras e plano de medi√ß√£o.","Go-live por ondas trimestrais; relat√≥rio bimestral de economia."], indicadores: ["Redu√ß√£o percentual do Custo Unit√°rio Total (R$/MWh): ‚â•20%","Baseline: Custo que seria pago no mercado cativo (shadow bill)."], prazos: "Meta de redu√ß√£o a ser atingida at√© 31/12/2025.", riscos: "Volatilidade de pre√ßos (portfolio ladder/hedge), varia√ß√£o de TUSD (cen√°rios de sensibilidade).", startDate: "2025-01-01", endDate: "2025-12-31", marcos: [{label: "Go-Live", date: "2025-06-30"}, {label: "Meta", date: "2025-12-31"}], historico: [] },
      { id: 7, area: "RH", titulo: "Desenvolvimento de Pessoas", status: "em_andamento", progresso: 65, cor: "var(--good)", objetivo: "Ampliar compet√™ncias t√©cnicas e gerenciais, realizando 4.000 capacita√ß√µes certificadas em 2025.", entregas: ["Plano Anual de Capacita√ß√£o com trilhas e cat√°logo de cursos.","Conte√∫dos EAD ass√≠ncronos e oficinas s√≠ncronas.","Dashboard de acompanhamento e certifica√ß√£o autom√°tica."], indicadores: ["Conclus√µes certificadas: 4.000","Alinhamento a trilhas priorit√°rias: ‚â•60%","Taxa de conclus√£o: ‚â•80%","Satisfa√ß√£o (CSAT/NPS): ‚â•85%"], prazos: "Plano anual com entregas cont√≠nuas ao longo de 2025.", riscos: "Baixa ades√£o (campanhas e turmas in-company), restri√ß√£o or√ßament√°ria (priorizar EAD e parcerias).", startDate: "2025-01-01", endDate: "2025-12-31", marcos: [{label: "Q1", date: "2025-03-31"}, {label: "Q2", date: "2025-06-30"}, {label: "Q3", date: "2025-09-30"}], historico: [] }
    ];

    const statusMap = {
      em_andamento: { label: "Em andamento", color: "var(--accent)" },
      risco: { label: "Em risco", color: "var(--warn)" },
      concluido: { label: "Conclu√≠do", color: "var(--good)" }
    };

    // --- DOM Elements ---
    const mainDashboard = document.getElementById('mainDashboard');
    const summarySection = document.getElementById('summarySection');
    const analysisSection = document.getElementById('analysisSection');
    const gridEl = document.getElementById('grid');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const modalDot = document.getElementById('modalDot');
    const summaryContent = document.getElementById('summaryContent');
    const themeToggleButton = document.getElementById('theme-toggle');
    let charts = {}; // To hold chart instances

    // --- THEME TOGGLE ---
    function applyTheme(theme) {
        if (theme === 'light') {
            document.body.classList.add('light-theme');
            themeToggleButton.textContent = 'üåô';
        } else {
            document.body.classList.remove('light-theme');
            themeToggleButton.textContent = '‚òÄÔ∏è';
        }
    }

    function toggleTheme() {
        const currentTheme = document.body.classList.contains('light-theme') ? 'light' : 'dark';
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        localStorage.setItem('dashboard-theme', newTheme);
        applyTheme(newTheme);
    }
    
    themeToggleButton.addEventListener('click', toggleTheme);
    
    // Apply saved theme on load
    const savedTheme = localStorage.getItem('dashboard-theme') || 'dark';
    applyTheme(savedTheme);


    // --- RENDERING FUNCTIONS ---
    function renderTimeline(meta) {
        const start = new Date(meta.startDate).getTime();
        const end = new Date(meta.endDate).getTime();
        const totalDuration = end - start;
        if (totalDuration <= 0) return '';

        const markers = meta.marcos.map(marco => {
            const markerDate = new Date(marco.date).getTime();
            const position = ((markerDate - start) / totalDuration) * 100;
            return `<div class="timeline-marker" style="left: ${position}%; background-color: ${meta.cor};" data-label="${marco.label} (${new Date(marco.date).toLocaleDateString('pt-BR')})"></div>`;
        }).join('');

        return `<div class="timeline"><div class="timeline-bar">${markers}</div></div>`;
    }

    function renderHistory(meta) {
        let items = meta.historico.map(h => `
            <div class="history-item">
                <small>${h.user} em ${new Date(h.date).toLocaleDateString('pt-BR')}</small>
                ${h.comment}
            </div>`).join('');
        if (meta.historico.length === 0) {
            items = '<p style="font-size:13px; color: var(--muted); text-align:center;">Nenhum registro no hist√≥rico.</p>';
        }

        return `
            <div class="history-log">
                <h4>Hist√≥rico de Atualiza√ß√µes</h4>
                <div id="history-list-${meta.id}">${items}</div>
                <form class="history-form" onsubmit="addHistoryEntry(${meta.id}, this.comment.value); this.comment.value=''; return false;">
                    <textarea name="comment" placeholder="Adicionar nova atualiza√ß√£o..." required></textarea>
                    <button type="submit" class="btn" style="margin-top: 8px; width: 100%;">Adicionar Registro</button>
                </form>
            </div>`;
    }

    function openMeta(meta) {
      modalTitle.textContent = meta.titulo;
      modalDot.style.background = statusMap[meta.status]?.color || 'var(--accent)';
      modalBody.innerHTML = `
        <div class="modal-content">
            <div>
                <div class="sections">
                    <div class="sec" style="grid-column: span 12;"><h4>Objetivo</h4><p>${meta.objetivo}</p></div>
                    <div class="sec"><h4>Entregas</h4><ul>${meta.entregas.map(x=>`<li>${x}</li>`).join('')}</ul></div>
                    <div class="sec"><h4>Indicadores</h4><ul>${(meta.indicadores || []).map(x=>`<li>${x}</li>`).join('')}</ul></div>
                    <div class="sec"><h4>Prazos</h4><p>${meta.prazos}</p></div>
                    <div class="sec"><h4>Riscos</h4><p>${meta.riscos}</p></div>
                </div>
            </div>
            <div>
                ${renderHistory(meta)}
            </div>
        </div>
        <div class="foot">
          <span class="pill"><span class="status-dot" style="background:${statusMap[meta.status]?.color || 'var(--accent)'}"></span>${statusMap[meta.status]?.label || 'Status'}</span>
          <button class="btn" onclick="modal.close()">Fechar</button>
        </div>
      `;
      modal.showModal();
    }

    function card(meta) {
      const st = statusMap[meta.status] || {label:'Status', color:'var(--accent)'};
      const el = document.createElement('article');
      el.className = 'card';
      el.innerHTML = `
        <div class="head">
          <div style="display:flex;align-items:center;gap:10px;">
            <div class="badge" style="background: linear-gradient(135deg, ${meta.cor}33, rgba(255,255,255,.06)); border:1px solid rgba(159,179,200,.16);">${meta.id}</div>
            <div>
              <h2>${meta.titulo}</h2>
              <div class="meta-tags">
                <span class="pill" style="border-color:${meta.cor}; color:${meta.cor}">${meta.area}</span>
                <span class="pill" style="border-color:${st.color};"><span class="status-dot" style="background:${st.color}"></span>${st.label}</span>
              </div>
            </div>
          </div>
          <div style="display:flex; align-items:center; gap: 8px;">
            <label for="progress-${meta.id}" style="font-size:12px; color: var(--muted);">Progresso:</label>
            <input type="number" min="0" max="100" value="${meta.progresso}" id="progress-${meta.id}" class="progress-input" oninput="updateProgress(${meta.id}, this.value)">
            <div class="donut" data-id="${meta.id}" style="--p:${meta.progresso||0}; --c:${meta.cor}" data-label="${(meta.progresso||0)}%"></div>
          </div>
        </div>
        <p style="color: var(--muted); margin: 4px 0 12px;">${meta.objetivo}</p>
        ${renderTimeline(meta)}
        <div class="foot">
          <button class="btn" onclick='openMeta(window.metas.find(m => m.id === ${meta.id}))'>Ver Detalhes e Hist√≥rico</button>
          <div class="meta-tags">
            <span class="tag">Atualizado: ${new Date().toLocaleDateString('pt-BR')}</span>
          </div>
        </div>
      `;
      return el;
    }

    function renderGrid(list) {
      gridEl.innerHTML = "";
      list.forEach(m => gridEl.appendChild(card(m)));
    }

    // --- LOGIC & EVENT HANDLERS ---
    function updateProgress(id, value) {
        const progress = Math.max(0, Math.min(100, Number(value)));
        const meta = metas.find(m => m.id === id);
        if (meta) {
            meta.progresso = progress;
            const donut = document.querySelector(`.donut[data-id='${id}']`);
            if (donut) {
                donut.style.setProperty('--p', progress);
                donut.setAttribute('data-label', `${progress}%`);
            }
        }
    }
    
    function addHistoryEntry(metaId, comment) {
        if (!comment.trim()) return;
        const meta = metas.find(m => m.id === metaId);
        if (meta) {
            const newEntry = {
                date: new Date().toISOString(),
                user: 'Gestor', // Placeholder user
                comment: comment
            };
            meta.historico.unshift(newEntry); // Add to the beginning
            
            const historyListEl = document.getElementById(`history-list-${metaId}`);
            if(historyListEl) {
                 let items = meta.historico.map(h => `
                    <div class="history-item">
                        <small>${h.user} em ${new Date(h.date).toLocaleDateString('pt-BR')}</small>
                        ${h.comment}
                    </div>`).join('');
                historyListEl.innerHTML = items;
            }
        }
    }

    function filterAndRender() {
      const q = document.getElementById('q').value.toLowerCase();
      const sf = document.getElementById('statusFilter').value;
      const filtered = metas.filter(m => {
        const hit = [m.titulo, m.objetivo, m.area].join(' ').toLowerCase();
        const statusOk = (sf === 'all') || (m.status === sf);
        return statusOk && hit.includes(q);
      });
      renderGrid(filtered);
    }
    
    function showView(viewName) {
        mainDashboard.classList.add('hidden');
        summarySection.classList.add('hidden');
        analysisSection.classList.add('hidden');
        if (viewName === 'dashboard') mainDashboard.classList.remove('hidden');
        if (viewName === 'summary') summarySection.classList.remove('hidden');
        if (viewName === 'analysis') analysisSection.classList.remove('hidden');
    }

    function buildAndShowSummary() {
        summaryContent.innerHTML = `
            <h1>Plano de Metas Estrat√©gicas 2025: Gest√£o, Pessoas e Efici√™ncia</h1>
            <h2>1. Resumo Executivo</h2>
            <p>Este documento detalha as sete metas estrat√©gicas priorit√°rias para 2025, focadas na moderniza√ß√£o da gest√£o de pessoas, governan√ßa financeira, intelig√™ncia de dados e efici√™ncia operacional. As iniciativas buscam resultados transformadores, como a unifica√ß√£o de sistemas de RH (ERGON) para maior controle e redu√ß√£o de custos; a revis√£o do ecossistema de consignados para beneficiar diretamente os servidores com cr√©dito mais barato e transparente; e a automa√ß√£o de processos financeiros atrav√©s de um gateway seguro.</p>
            <p>Adicionalmente, o plano prev√™ a cria√ß√£o de uma plataforma de Business Intelligence para subsidiar decis√µes com dados precisos, a reestrutura√ß√£o de cargos sem impacto fiscal para otimizar a for√ßa de trabalho, a busca por efici√™ncia energ√©tica com uma meta arrojada de 20% de economia no Mercado Livre de Energia, e um ambicioso programa de capacita√ß√£o para 4.000 servidores, alinhado √†s compet√™ncias do futuro.</p>
            <p>Juntas, essas metas formam um programa coeso que visa aprimorar a governan√ßa, gerar economia para o er√°rio, valorizar os servidores e preparar a administra√ß√£o municipal para os desafios futuros, utilizando tecnologia e dados como pilares centrais.</p>
            
            <hr style="border-color: var(--line); margin: 24px 0;">

            <h2>2. Painel de Metas Estrat√©gicas</h2>
            ${metas.map(m => `
                <div style="margin-bottom: 24px;">
                    <h3>Meta ${m.id}: ${m.titulo}</h3>
                    <ul style="list-style-type: none; padding-left: 10px;">
                        <li><strong>Objetivo:</strong> ${m.objetivo}</li>
                        <li><strong>Entregas Principais:</strong><ul>${m.entregas.map(e => `<li>${e}</li>`).join('')}</ul></li>
                        <li><strong>Indicadores e Metas:</strong><ul>${(m.indicadores || []).map(i => `<li>${i}</li>`).join('')}</ul></li>
                        <li><strong>Prazo/Marcos:</strong> ${m.prazos}</li>
                        <li><strong>Riscos & Mitiga√ß√£o:</strong> ${m.riscos}</li>
                    </ul>
                </div>
            `).join('')}
        `;
        showView('summary');
    }
    
    function generateSummaryPDF() {
        alert("A gera√ß√£o de PDF √© bloqueada na pr√©-visualiza√ß√£o, mas funcionar√° em um ambiente web real.");
    }
    
    // --- ANALYSIS DASHBOARD ---
    function buildAndShowAnalysis() {
        showView('analysis');
        Object.values(charts).forEach(chart => { if(chart.destroy) chart.destroy(); });

        const textColor = document.body.classList.contains('light-theme') ? '#0f172a' : '#e5eef5';
        const gridColor = document.body.classList.contains('light-theme') ? '#e2e8f0' : '#1f2a44';

        const areas = [...new Set(metas.map(m => m.area))];
        const progressByAreaData = {
            labels: areas,
            datasets: [{
                label: 'Progresso M√©dio (%)',
                data: areas.map(area => {
                    const areaMetas = metas.filter(m => m.area === area);
                    const totalProgress = areaMetas.reduce((sum, m) => sum + m.progresso, 0);
                    return areaMetas.length > 0 ? (totalProgress / areaMetas.length).toFixed(2) : 0;
                }),
                backgroundColor: 'rgba(59, 130, 246, 0.6)',
                borderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 1
            }]
        };
        charts.progressByArea = new Chart(document.getElementById('progressByAreaChart'), { type: 'bar', data: progressByAreaData, options: { responsive: true, indexAxis: 'y', scales: { x: { ticks: { color: textColor }, grid: { color: gridColor } }, y: { ticks: { color: textColor }, grid: { color: gridColor } } }, plugins: { legend: { labels: { color: textColor } } } } });

        const statusCounts = metas.reduce((acc, m) => {
            acc[m.status] = (acc[m.status] || 0) + 1;
            return acc;
        }, {});
        const statusDistributionData = {
            labels: Object.keys(statusCounts).map(s => statusMap[s].label),
            datasets: [{
                data: Object.values(statusCounts),
                backgroundColor: Object.keys(statusCounts).map(s => statusMap[s].color),
            }]
        };
        charts.statusDistribution = new Chart(document.getElementById('statusDistributionChart'), { type: 'doughnut', data: statusDistributionData, options: { responsive: true, plugins: { legend: { position: 'top', labels: { color: textColor } } } } });

        const risksByAreaData = {
            labels: areas,
            datasets: [{
                label: 'N¬∫ de Metas em Risco',
                data: areas.map(area => metas.filter(m => m.area === area && m.status === 'risco').length),
                backgroundColor: 'rgba(245, 158, 11, 0.6)',
                borderColor: 'rgba(245, 158, 11, 1)',
                borderWidth: 1
            }]
        };
        charts.risksByArea = new Chart(document.getElementById('risksByAreaChart'), { type: 'bar', data: risksByAreaData, options: { responsive: true, scales: { x: { ticks: { color: textColor }, grid: { color: gridColor } }, y: { ticks: { color: textColor }, grid: { color: gridColor } } }, plugins: { legend: { labels: { color: textColor } } } } });
    }

    // --- INITIALIZATION ---
    document.getElementById('q').addEventListener('input', filterAndRender);
    document.getElementById('statusFilter').addEventListener('change', filterAndRender);
    document.getElementById('printBtn').addEventListener('click', () => window.print());
    document.getElementById('summaryBtn').addEventListener('click', buildAndShowSummary);
    document.getElementById('analysisBtn').addEventListener('click', buildAndShowAnalysis);
    document.getElementById('backToDashboardBtn').addEventListener('click', () => showView('dashboard'));
    document.getElementById('backToDashboardBtn2').addEventListener('click', () => showView('dashboard'));
    document.getElementById('printSummaryBtn').addEventListener('click', generateSummaryPDF);

    filterAndRender();

    window.metas = metas;
    window.updateProgress = updateProgress;
    window.openMeta = openMeta;
    window.addHistoryEntry = addHistoryEntry;
  </script>
</body>
</html>